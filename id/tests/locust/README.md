# Нагрузочные тесты Locust

## Предварительная настройка

### 1. Переменные окружения

Убедитесь, что установлены следующие переменные окружения:

- `LOCUST_HOST` - URL тестируемого приложения (например, `http://localhost:80` или `http://127.0.0.1:80`)
- `EMAIL_VERIFICATION_REDIS_URL` - URL Redis для получения кодов верификации (по умолчанию `redis://127.0.0.1:6379/2`)

### 2. Feature Flags

Все feature flags должны быть отключены, включая `smartcaptcha_enabled`. Капча не будет проверяться в тестах.

### 3. Email отправка

Тесты проверяют только статус ответа при отправке кода (200 OK означает, что задача поставлена в очередь Celery). Реальная отправка email происходит асинхронно через Celery и не блокирует сервер.

Для предотвращения блокировки email сервера рекомендуется:
- Использовать тестовый email backend (например, консольный или файловый)
- Или настроить ограничения на количество отправляемых писем
- Или использовать моки для email отправки в тестовом окружении

### 4. Redis доступ

Тесты получают коды верификации напрямую из Redis кэша. Убедитесь, что:
- Redis доступен для чтения
- Используется правильный database index (по умолчанию 2 для email_verification)

## Запуск тестов

### Базовый запуск

```bash
locust -f id/tests/locust/locustfile.py --host=http://localhost:80
```

### Запуск с указанием количества пользователей

```bash
locust -f id/tests/locust/locustfile.py --host=http://localhost:80 --users 100 --spawn-rate 10
```

### Запуск в headless режиме

```bash
locust -f id/tests/locust/locustfile.py --host=http://localhost:80 --users 100 --spawn-rate 10 --headless --run-time 5m
```

### Запуск с выбором конкретных классов пользователей

```bash
locust -f id/tests/locust/locustfile.py --host=http://localhost:80 --users 50 --spawn-rate 5 --classes AnonymousUser RegistrationUser
```

## Классы пользователей

### AnonymousUser
Тестирует анонимные операции:
- Получение CSRF токена
- Получение feature flags
- Проверка email
- Отправка кодов верификации
- Верификация кодов (включая невалидные)

### RegistrationUser
Тестирует полный флоу регистрации:
- Полная регистрация с верификацией email
- Регистрация без верификации (ожидается ошибка)
- Регистрация с несовпадающими паролями (ожидается ошибка)

### LoginUser
Тестирует операции входа:
- Успешный вход
- Вход с неверными учетными данными
- Блокировка при множественных неудачных попытках

### AuthenticatedUser
Тестирует операции аутентифицированных пользователей:
- Получение информации о пользователе
- Выход из системы

### PasswordResetUser
Тестирует полный флоу восстановления пароля:
- Полное восстановление пароля
- Восстановление без верификации (ожидается ошибка)
- Восстановление с несовпадающими паролями (ожидается ошибка)

## Покрытие статусов ответов

Тесты проверяют следующие статусы:

- `200 OK` - успешные операции
- `201 Created` - успешная регистрация
- `400 Bad Request` - невалидные данные, ошибки валидации
- `401 Unauthorized` - неверные учетные данные
- `403 Forbidden` - блокировка, неаутентифицирован
- `404 Not Found` - email не существует
- `429 Too Many Requests` - превышен лимит запросов
- `500 Internal Server Error` - ошибка отправки email

## Метрики

Locust собирает следующие метрики:
- Время ответа для каждого эндпоинта
- Процент успешных/неуспешных запросов
- Количество запросов в секунду (RPS)
- Количество ошибок по типам
- Пропускная способность системы

## Примечания

1. Тесты используют случайные IP адреса для проверки блокировок и лимитов
2. Коды верификации получаются из Redis с небольшой задержкой (до 1 секунды) для учета асинхронной обработки
3. Для предотвращения блокировки email сервера рекомендуется использовать тестовый backend или ограничения
